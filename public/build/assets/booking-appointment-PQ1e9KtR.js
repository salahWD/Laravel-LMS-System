var O=["January","February","March","April","May","June","July","August","September","October","November","December"],z=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];document.addEventListener("DOMContentLoaded",function(){var c=document.getElementById("calendar"),l=new FullCalendar.Calendar(c,{initialView:"dayGridMonth",businessHours:{daysOfWeek:allAvailableTimes.map(f=>{if(f.key!="excluded")return f.key})},height:"auto",selectable:!0,select:function(f){var g=new Date,e=f.start;if(e>g){for(var o=document.getElementById("available-times-div");o.firstChild;)o.removeChild(o.lastChild);var t=document.createElement("h4"),a=document.createTextNode(z[e.getDay()]+", "+O[e.getMonth()]+" "+e.getDate());t.appendChild(a),o.appendChild(t);let r=allAvailableTimes.filter((u,D)=>u.key==e.getDay());if(r.length>0){r.forEach(s=>{F(s).forEach(E=>{var T=document.createElement("div");T.classList.add("time-slot"),T.dataset.time=E.start;var S=document.createElement("button"),C=document.createTextNode(E.start);S.classList.add("time-btn"),S.appendChild(C),T.appendChild(S),o.appendChild(T),window.last=null,S.addEventListener("click",function(){window.last!=null&&last.parentNode.removeChild(last.parentNode.lastChild);var y=document.createElement("button"),v=document.createTextNode("Confirm");y.classList.add("confirm-btn"),y.appendChild(v),this.parentNode.appendChild(y);let p=this.textContent;y.addEventListener("click",function(){const d=new Date(`${O[e.getMonth()]} ${e.getDate()}, ${e.getFullYear()} ${N(p)}`);let i=new Date(d.toLocaleString("en-US",{timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone})),n=document.createElement("form");n.method="POST",n.action=AppointmentsUrl;let w=document.createElement("input");w.name="_token",w.value=document.querySelector("meta[name='csrf-token']").getAttribute("content"),n.appendChild(w),n.style="display: none;";let b=document.createElement("input");if(b.name="date",b.value=i.toISOString(),console.log(i.toISOString()),n.appendChild(b),has_price){let h=document.createElement("input");h.name="intentId",h.value=clientSecret,n.appendChild(h)}if(document.body.appendChild(n),has_price){document.getElementById("pages").classList.add("show-last-page");let h=i.getHours(),M=i.getMinutes(),_=i.getHours()>=12?"pm":"am",I=`${h>9?h:"0"+h}:${M>9?M:"0"+M} ${_}`;i.setMinutes(i.getMinutes()+AppointmentDuration);let k=i.getHours(),A=i.getMinutes(),q=i.getHours()>=12?"pm":"am";I=`${I} - ${k>9?k:"0"+k}:${A>9?A:"0"+A} ${q}`,document.getElementById("event-time-stamp").innerText=`${I} ${O[e.getMonth()]} ${e.getDate()}, ${e.getFullYear()}`,window.bookingForm=n}else return n.submit(),!0}),window.last=S})})});let u=e.getMonth(),D=e.getDate();const x=`${e.getFullYear()}-${u>=9?u+1:"0"+(u+1)}-${D>9?D:"0"+D}T00:00:00${P(Intl.DateTimeFormat().resolvedOptions().timeZone)}`;fetch(AppointmentsUrl+"/unavailable?date="+encodeURI(new Date(x).toISOString()),{method:"GET",headers:{"Content-Type":"application/json"}}).then(s=>s.json()).then(s=>{var L,E,T,S;if(((L=s==null?void 0:s.excluded)==null?void 0:L.length)>0||((E=s==null?void 0:s.booked)==null?void 0:E.length)>0){let C=[];if(r.forEach(y=>{const v=F(y,new Date(x));C.push(...v)}),((T=s==null?void 0:s.booked)==null?void 0:T.length)>0){const y=s.booked.map(p=>{const d=Intl.DateTimeFormat().resolvedOptions().timeZone,i=new Date(p),w=new Intl.DateTimeFormat("en-US",{timeZone:d,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(i),b=`${w[4].value}-${w[0].value}-${w[2].value} ${w[6].value}:${w[8].value}:${w[10].value}`;console.log("Original Time (Appointment's Timezone):",p),console.log("Converted Time in User's Timezone:",b);const h=new Date(b);return h.setMinutes(h.getMinutes()+AppointmentDuration),console.log({start:new Date(b),end:h}),{start:new Date(b),end:h}}),v=C.filter(p=>{const d=new Date(p.date),i=new Date(p.date);return i.setMinutes(d.getMinutes()+AppointmentDuration),y.some(n=>d>=n.start&&d<=n.end||i>=n.start&&i<=n.end||d<=n.start&&i>=n.end)});v.length>0&&v.forEach(p=>{let d=document.querySelector(`#available-times-div .time-slot[data-time="${p.start}"] button`);d.setAttribute("disabled",!0),d.parentElement.classList.add("disabled")})}if(((S=s==null?void 0:s.excluded)==null?void 0:S.length)>0){const y=s.excluded.map(p=>({start:new Date(p.from),end:new Date(p.to)})),v=C.filter(p=>{const d=new Date(p.date),i=new Date(p.date);return i.setMinutes(d.getMinutes()+AppointmentDuration),y.some(n=>d>=n.start&&d<=n.end||i>=n.start&&i<=n.end||d<=n.start&&i>=n.end)});v.length>0&&v.forEach(p=>{let d=document.querySelector(`#available-times-div .time-slot[data-time="${p.start}"] button`);d.setAttribute("disabled",!0),d.parentElement.classList.add("disabled")})}}}).catch(s=>console.error("Error:",s))}else{let u=document.createElement("div"),D=document.createTextNode("No Available Time To Book");u.appendChild(D),u.classList.add("alert","alert-warning"),o.appendChild(u)}var m=document.getElementsByClassName("container")[0];m.classList.add("time-div-active"),document.getElementById("calendar-section").style.flex="2",o.style.display="initial",l.updateSize()}else l.unselect()}});l.render()});document.getElementById("back-to-booking").addEventListener("click",function(){document.getElementById("pages").classList.remove("show-last-page")});function F(c,l=null){const[f,g]=[c.from_date.substring(2),c.to_date.substring(2)],e=Intl.DateTimeFormat().resolvedOptions().timeZone;let o;l?o=U(l,e):o=U(new Date,e);let t=new Date(`${o.substring(0,11)}${f}`),a=new Date(`${o.substring(0,11)}${g}`);t=new Date(t.toLocaleString("en-US",{timeZone:e})),a=new Date(a.toLocaleString("en-US",{timeZone:e}));const m=[];let r=new Date(t);if(a<r){let u=a;a=r,r=u}for(;r<=a;){const u=new Date(r);u.setMinutes(u.getMinutes()+AppointmentDuration),u>a&&u.setTime(a.getTime()),r<a&&m.push({date:r.toISOString(),start:B(r),end:B(u)}),r.setMinutes(r.getMinutes()+AppointmentDuration+AppointmentBufferZone)}return m}function N(c){const[l,f]=c.split(" ");let[g,e]=l.split(":");return g==="12"&&(g="00"),f.toLowerCase()==="pm"&&(g=parseInt(g,10)+12),`${g.toString().padStart(2,"0")}:${e.padStart(2,"0")}`}function B(c){const l=c.getHours(),f=c.getMinutes(),g=l>=12?"pm":"am";return`${(l%12===0?12:l%12).toString().padStart(2,"0")}:${f.toString().padStart(2,"0")} ${g}`}if(has_price){let o=function(a){const m=document.querySelector("#payment-message");m.classList.remove("hidden"),m.textContent=a,setTimeout(function(){m.classList.add("hidden"),m.textContent=""},7e3)},t=function(a){a?(document.querySelector("#submitBtn").disabled=!0,document.querySelector("#spinner").classList.remove("hidden"),document.querySelector("#button-text").classList.add("hidden")):(document.querySelector("#submitBtn").disabled=!1,document.querySelector("#spinner").classList.add("hidden"),document.querySelector("#button-text").classList.remove("hidden"))};var Z=o,H=t;const c=Stripe(stripeKey);let l;$(window).ready(function(){f(),e()}),document.querySelector("#payment-form").addEventListener("submit",g);async function f(){l=c.elements({clientSecret:clientSecretKey}),l.create("payment").mount("#payment-element")}async function g(a){a.preventDefault(),t(!0),fetch(AppointmentsUrl,{method:"POST",body:new FormData(window.bookingForm)}).then(r=>r.json()).then(r=>{console.log(r)}).catch(r=>console.error("Error:",r));const{error:m}=await c.confirmPayment({elements:l,confirmParams:{return_url:successUrl}});m&&(m.type==="card_error"||m.type==="validation_error"?o(m.message):o("An unexpected error occurred."),t(!1))}async function e(){const a=new URLSearchParams(window.location.search).get("payment_intent_client_secret");if(!a)return;const{paymentIntent:m}=await c.retrievePaymentIntent(a);switch(m.status){case"succeeded":o("Payment succeeded!");break;case"processing":o("Your payment is processing.");break;case"requires_payment_method":o("Your payment was not successful, please try again.");break;default:o("Something went wrong.");break}}}function U(c,l){const f={timeZone:l,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1},e=new Intl.DateTimeFormat("en-GB",f).formatToParts(c);return`${e.find(t=>t.type==="year").value}-${e.find(t=>t.type==="month").value}-${e.find(t=>t.type==="day").value}T${e.find(t=>t.type==="hour").value}:${e.find(t=>t.type==="minute").value}:${e.find(t=>t.type==="second").value}`}function P(c){const f=new Date().toLocaleString("en-US",{timeZone:c}),e=new Date(f).getTimezoneOffset(),o=Math.floor(Math.abs(e)/60),t=Math.abs(e)%60;return`${e<=0?"+":"-"}${String(o).padStart(2,"0")}:${String(t).padStart(2,"0")}`}
